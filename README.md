# ü•îüîÅ POTATO Tipper contract - [![Build + Test pass](https://github.com/CJ42/potato-tipper-contract/actions/workflows/test.yml/badge.svg)](https://github.com/CJ42/potato-tipper-contract/actions/workflows/test.yml) [![Code coverage](https://img.shields.io/badge/Code_Coverage-87%25-green?logo=codecrafters&logoColor=white)](./README.md#code-coverage)

Smart contracts of the POTATO Tipper, a contract that enables you to tip on follow, acting as an incentive mechanism to gain new followers.

| Network       | Contract address |
| :------------ | :--------------- |
| LUKSO Mainnet | üîú               |
| LUKSO Testnet | üîú               |

> **‚ö†Ô∏è Disclaimer:** the `PotatoTipper.sol` contract is experimental. Use it responsibly and at your own risk.
>
> Although it has been thoroughly tested with Foundry and some auditing tools, it has not been formally audited by an external third party auditor.
>
> See the **Security Notes & Limitations** for more details on the auditing tools used and the known trade-offs.

## Overview

- ü´° Permission-less (not controlled by anyone). Purely an automatic tipping mechanism on-chain.
- ‚öôÔ∏è Configurable settings:

  - customizable tip amount (ü•î, or ü•îü•î, or ü•îü•îü•î, or more...)
  - allocated tipping budget (cannot use user's full ü•î balance unless configured as such)
  - eligibility criterias for a new follower to get a tip (e.g: at least have 3 followers)

- ‚úÖüÜô Only Universal Profile can receive tips (‚ùåüîë not EOAs)
  - only one tip per UP they follow.
  - Existing followers are not eligible to receive tips.

**For the smart contract technicalities:**

- üì¢ Built as an LSP1 Universal Receiver Delegate contract.
- üîå Work automatically once it is _"plugged-in_ to a Universal Profile to reacts on follow / unfollow notifications from LSP26 Follower System. This can be done by setting the Potato Tipper contract address as a value under the following data keys in a UP:

  - `LSP1UniversalReceiverDelegate:LSP26FollowerSystem_FollowNotification` -> `0x0cfc51aec37c55a4d0b1000071e02f9f05bcd5816ec4f3134aa2e5a916669537`
  - `LSP1UniversalReceiverDelegate:LSP26FollowerSystem_UnfollowNotification` -> `0x0cfc51aec37c55a4d0b100009d3c0b4012b69658977b099bdaa51eff0f0460f4`

- ü§ùüèª Act as an operator via `authorizeOperator(...)` to transfer tokens on behalf of the user's UP.
  - Give it the allocated tipping budget as authorized amount / allowance.
  - No ü•î tokens need to be transferred to the Potato Tipper contract (it transfers them on behalf of the user's UP)

## Code Coverage

```
‚ï≠----------------------+----------------+----------------+---------------+---------------‚ïÆ
| File                 | % Lines        | % Statements   | % Branches    | % Funcs       |
+========================================================================================+
| src/PotatoTipper.sol | 95.45% (42/44) | 95.24% (40/42) | 85.71% (6/7)  | 100.00% (8/8) |
‚ï∞----------------------+----------------+----------------+---------------+---------------‚ïØ

Uncovered for src/PotatoTipper.sol:
- Line (location: source ID 102, lines 137..138, bytes 14351..14408, hits: 0)
- Statement (location: source ID 102, lines 137..138, bytes 14351..14408, hits: 0)
- Branch (branch: 13, path: 0) (location: source ID 102, lines 234..237, bytes 19179..19277, hits: 0)
- Line (location: source ID 102, lines 235..236, bytes 19197..19262, hits: 0)
- Statement (location: source ID 102, lines 235..236, bytes 19197..19262, hits: 0)
```

## Security Notes + Limitations

- New followers can only get tipped once. They cannot unfollow and re-follow to try to get tips many times.
- The Potato Tipper only works for new followers (therefore the notion of an _"incentive system"_). Existing followers cannot get tipped (as mentioned above). If a user (Alice) connects the Potato Tipper to its UP, and Bob was following Alice before she used the Potato Tipper, Bob will never be able to get a tip from the Potato Tipper contract. Even by trying to unfollow and re-follow Alice.
- If Alice's UP follows Bob's UP and get tipped some ü•î, this does not guarantee that Alice will keep following Bob's afterwards. If Alice unfollows Bob, Bob will not get the ü•î he tipped back. The Potato Tipper is not opinionated towards this behaviour as UPs might unfollow each other afterwards for legitimate reasons. The Potato Tipper cannot differentiate that.

## Development

### Pre-requisites

1. Install the [**`bun`** package manager](https://bun.sh/package-manager).
2. [Install foundry](https://getfoundry.sh/).
3. Install the dependencies

```bash
forge install
bun install

# Compile the contracts (ABI + generated bytecode in `build/` folder)
bun run build

# Bun commands for tests below uses under the hood the flag `--fork-url https://rpc.mainnet.lukso.network`

# Run fork tests against LUKSO mainnet
bun run test

# Run fork tests + display gas report
bun run test:gas

# Run fork tests + show code coverage
bun run test:coverage

# Format Solidity code
# Formatting rules can be adjusted under the `[fmt]` section in the `foundry.toml` file
bun run format
```

### Gas report

```log
[PASS] test_FollowerDoesNotAlreadyFollowUser() (gas: 15200)
[PASS] test_FollowerFollowUser() (gas: 182328)
[PASS] test_IsLSP1Delegate() (gas: 8391)
[PASS] test_PotatoTipperIsRegisteredForNotificationTypeNewFollower() (gas: 17195)
[PASS] test_cannotTipTwiceTheSameNewFollowerIfFollowedUnfollowAndRefollow() (gas: 676043)
Logs:
  Found UniversalReceiver event related to a typeId new follow at index: 5

[PASS] test_followerCanReceiveTipsFromTwoDifferentUsersWhoConnectedPotatoTipper() (gas: 855803)
[PASS] test_shouldNotTipIfPotatoTipperHasNotBeenAuthorizedAsOperator() (gas: 205597)
[PASS] test_tippingOnFollowAfterAuthorizingPotatoTipperAsOperator() (gas: 438184)
```

### Documentation

This template repository is based on Foundry, **a blazing fast, portable and modular toolkit for EVM application development written in Rust.** It includes:

- **Forge**: Ethereum testing framework (like Truffle, Hardhat and DappTools).
- **Cast**: Swiss army knife for interacting with EVM smart contracts, sending transactions and getting chain data.
- **Anvil**: Local Ethereum node, akin to Ganache, Hardhat Network.
- **Chisel**: Fast, utilitarian, and verbose solidity REPL.

You can find more documentation at: https://book.getfoundry.sh/
